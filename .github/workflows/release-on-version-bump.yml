name: Release on Version Bump

on:
  push:
    branches: ["main", "master"]
    paths:
      - "app/build.gradle"
      - "app/build.gradle.kts"
      - "gradle.properties"
      - "app/src/main/AndroidManifest.xml"
  workflow_dispatch: {}

concurrency:
  group: release-on-version-bump
  cancel-in-progress: false

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ç”Ÿæˆ changelog

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2
        continue-on-error: true
        timeout-minutes: 2

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Detect version change
        id: version
        env:
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}
        run: |
          python3 - <<'PY'
          import os, re, subprocess

          def read_file(path):
              try:
                  with open(path, 'r', encoding='utf-8') as f:
                      return f.read()
              except FileNotFoundError:
                  return None

          def parse_versions(text):
              if not text:
                  return None, None
              vn = None
              vc = None
              m = re.search(r'versionName\s*[= ]\s*"?([0-9A-Za-z\.-_\+]+)"?', text)
              if m:
                  vn = m.group(1)
              m = re.search(r'versionCode\s*[= ]\s*"?([0-9]+)"?', text)
              if m:
                  vc = m.group(1)
              if vn is None:
                  m = re.search(r'(?im)^\s*(?:VERSION_NAME|versionName)\s*=\s*([^\s#]+)', text)
                  if m:
                      vn = m.group(1).strip()
              if vc is None:
                  m = re.search(r'(?im)^\s*(?:VERSION_CODE|versionCode)\s*=\s*([0-9]+)', text)
                  if m:
                      vc = m.group(1).strip()
              if vn is None:
                  m = re.search(r'android:versionName\s*=\s*"([^"]+)"', text)
                  if m:
                      vn = m.group(1)
              if vc is None:
                  m = re.search(r'android:versionCode\s*=\s*"([^"]+)"', text)
                  if m:
                      vc = m.group(1)
              return vn, vc

          def get_file_at_rev(path, rev=None):
              if rev is None:
                  return read_file(path)
              try:
                  out = subprocess.check_output(['git', 'show', f'{rev}:{path}'], stderr=subprocess.STDOUT)
                  return out.decode('utf-8', errors='ignore')
              except subprocess.CalledProcessError:
                  return None

          paths = ['app/build.gradle', 'app/build.gradle.kts', 'gradle.properties', 'app/src/main/AndroidManifest.xml']

          text_head = None
          for p in paths:
              content = get_file_at_rev(p, None)
              if content:
                  text_head = content
                  break
          vn_head, vc_head = parse_versions(text_head)

          prev_rev = os.environ.get('GITHUB_EVENT_BEFORE') or 'HEAD^'
          text_prev = None
          for p in paths:
              content = get_file_at_rev(p, prev_rev)
              if content:
                  text_prev = content
                  break
          vn_prev, vc_prev = parse_versions(text_prev)

          # åªæ£€æŸ¥ versionCode æ˜¯å¦å˜åŒ–
          changed = False
          if vc_head and (vc_head != (vc_prev or '')):
              changed = True

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'version_name={vn_head or ""}\n')
              f.write(f'version_code={vc_head or ""}\n')
              f.write(f'prev_version_name={vn_prev or ""}\n')
              f.write(f'prev_version_code={vc_prev or ""}\n')
              f.write(f'changed={"true" if changed else "false"}\n')
          PY

      - name: Stop if versionCode didn't change
        if: steps.version.outputs.changed != 'true'
        run: |
          echo "versionCode æœªå˜åŒ–,è·³è¿‡ releaseã€‚"
          echo "å½“å‰ versionCode: ${{ steps.version.outputs.version_code }}"
          exit 0

      - name: Get previous tag
        id: prev_tag
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
          echo "ä¸Šä¸€ä¸ª tag: $PREV_TAG"

      - name: Compose current tag
        id: tag
        run: |
          V="${{ steps.version.outputs.version_name }}"
          if [ -z "$V" ]; then V="${{ steps.version.outputs.version_code }}"; fi
          if [ -z "$V" ]; then V="$(date +%Y%m%d)-${{ github.sha }}"; fi
          echo "tag=v$V" >> "$GITHUB_OUTPUT"
          echo "version_display=$V" >> "$GITHUB_OUTPUT"
          echo "å½“å‰ tag: v$V"

      - name: Generate changelog between tags
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ steps.tag.outputs.tag }}"

          if [ -z "$PREV_TAG" ]; then
            echo "## ğŸ“ æ›´æ–°æ—¥å¿—" > changelog.md
            echo "" >> changelog.md
            echo "è¿™æ˜¯é¦–ä¸ªå‘å¸ƒç‰ˆæœ¬ã€‚" >> changelog.md
            echo "" >> changelog.md
            echo "### æ‰€æœ‰æäº¤" >> changelog.md
            git log --pretty=format:"- %s (%h) - %an" --no-merges >> changelog.md

            # ç”Ÿæˆç®€çŸ­ç‰ˆæœ¬ç”¨äº version.json
            echo "é¦–ä¸ªå‘å¸ƒç‰ˆæœ¬" > release_notes_short.txt
          else
            echo "## ğŸ“ æ›´æ–°æ—¥å¿— ($PREV_TAG â†’ $CURRENT_TAG)" > changelog.md
            echo "" >> changelog.md
            echo "### ğŸ¯ ç‰ˆæœ¬ä¿¡æ¯" >> changelog.md
            echo "- **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version_name }}" >> changelog.md
            echo "- **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}" >> changelog.md
            echo "- **ä¸Šä¸€ç‰ˆæœ¬**: ${{ steps.version.outputs.prev_version_name }} (code: ${{ steps.version.outputs.prev_version_code }})" >> changelog.md
            echo "" >> changelog.md

            echo "### ğŸ“‹ æœ¬æ¬¡æ›´æ–°å†…å®¹" >> changelog.md
            echo "" >> changelog.md

            # è·å–è¯¦ç»†çš„ commit ä¿¡æ¯
            git log $PREV_TAG..HEAD --pretty=format:"- **%s**%n  - æäº¤: %h | ä½œè€…: %an | æ—¶é—´: %ai%n" --no-merges >> changelog.md

            echo "" >> changelog.md
            echo "" >> changelog.md
            echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> changelog.md
            COMMIT_COUNT=$(git rev-list $PREV_TAG..HEAD --count)
            echo "- æäº¤æ•°é‡: $COMMIT_COUNT" >> changelog.md
            FILES_CHANGED=$(git diff --shortstat $PREV_TAG..HEAD | sed 's/^[[:space:]]*//')
            if [ -n "$FILES_CHANGED" ]; then
              echo "- æ–‡ä»¶å˜æ›´: $FILES_CHANGED" >> changelog.md
            fi

            # ç”Ÿæˆç®€çŸ­ç‰ˆæœ¬ç”¨äº version.jsonï¼ˆåªåŒ…å« commit æ ‡é¢˜ï¼‰
            echo "æœ¬æ¬¡æ›´æ–°åŒ…å« $COMMIT_COUNT ä¸ªæäº¤:" > release_notes_short.txt
            git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges >> release_notes_short.txt
          fi

          # ä¸å†é€šè¿‡ $GITHUB_OUTPUT ä¼ é€’å¤šè¡Œå†…å®¹ï¼Œä»¥é¿å…åˆ†éš”ç¬¦è§£æé—®é¢˜ã€‚
          # åç»­æ­¥éª¤ç›´æ¥è¯»å– changelog.md ä¸ release_notes_short.txt æ–‡ä»¶ã€‚
          echo "âœ… changelog ä¸ç®€çŸ­æ›´æ–°è¯´æ˜å·²ç”Ÿæˆåˆ°å·¥ä½œåŒºæ–‡ä»¶ã€‚"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      - name: Check if keystore is configured
        id: check_keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "has_keystore=true" >> "$GITHUB_OUTPUT"
            echo "âœ… æ£€æµ‹åˆ°ç­¾åå¯†é’¥é…ç½®"
          else
            echo "has_keystore=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ æœªé…ç½®ç­¾åå¯†é’¥,å°†æ„å»º Debug APK"
          fi

      - name: Decode and setup keystore
        if: steps.check_keystore.outputs.has_keystore == 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "è§£ç ç­¾åå¯†é’¥..."
          echo "$KEYSTORE_BASE64" | base64 -d > release.keystore
          echo "KEYSTORE_FILE=${{ github.workspace }}/release.keystore" >> $GITHUB_ENV
          ls -lh release.keystore

      - name: Make Gradle wrapper executable
        run: |
          chmod +x ./gradlew || true
          sed -i -e 's/\r$//' ./gradlew || true

      - name: Build Release APK with signing
        if: steps.check_keystore.outputs.has_keystore == 'true'
        env:
          KEYSTORE_FILE: ${{ env.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "ä½¿ç”¨ç­¾åå¯†é’¥æ„å»º Release APK..."
          ./gradlew --no-daemon clean assembleRelease
          ls -lh app/build/outputs/apk/release/

      - name: Build Debug APK (fallback)
        if: steps.check_keystore.outputs.has_keystore != 'true'
        run: |
          echo "æœªé…ç½®ç­¾åå¯†é’¥,æ„å»º Debug APK..."
          ./gradlew --no-daemon clean assembleDebug

      - name: Locate built APK
        id: locate_apk
        run: |
          # ä¼˜å…ˆæŸ¥æ‰¾ release APK
          RELEASE_APK=$(ls app/build/outputs/apk/release/*.apk 2>/dev/null | grep -v unaligned | head -n 1 || true)
          DEBUG_APK=$(ls app/build/outputs/apk/debug/*.apk 2>/dev/null | head -n 1 || true)

          if [ -n "$RELEASE_APK" ]; then
            APK_PATH="$RELEASE_APK"
            APK_TYPE="release"
          elif [ -n "$DEBUG_APK" ]; then
            APK_PATH="$DEBUG_APK"
            APK_TYPE="debug"
          else
            APK_PATH=""
            APK_TYPE="none"
          fi

          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_type=$APK_TYPE" >> "$GITHUB_OUTPUT"

          if [ -n "$APK_PATH" ]; then
            echo "æ‰¾åˆ° APK ($APK_TYPE): $APK_PATH"
            ls -lh "$APK_PATH"
          else
            echo "æœªæ‰¾åˆ° APK æ–‡ä»¶"
          fi

      - name: Rename APK
        if: steps.locate_apk.outputs.apk_path != ''
        id: rename_apk
        run: |
          APK_PATH="${{ steps.locate_apk.outputs.apk_path }}"
          APK_TYPE="${{ steps.locate_apk.outputs.apk_type }}"
          VERSION="${{ steps.version.outputs.version_name }}"

          # ç”Ÿæˆæ–°æ–‡ä»¶å
          NEW_NAME="lexisharp-keyboard-${VERSION}-${APK_TYPE}.apk"
          NEW_PATH="app/build/outputs/apk/${NEW_NAME}"

          cp "$APK_PATH" "$NEW_PATH"
          echo "renamed_apk_path=$NEW_PATH" >> "$GITHUB_OUTPUT"
          echo "é‡å‘½å APK: $NEW_NAME"
          ls -lh "$NEW_PATH"

      - name: Update version.json
        id: update_version_json
        run: |
          echo "ğŸ“ æ›´æ–° version.json æ–‡ä»¶..."

          # ä½¿ç”¨ Python ç”Ÿæˆ JSONï¼ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
          python3 - <<'PY'
          import json
          import os
          from datetime import datetime

          version = os.environ.get('VERSION', '0.0.0')
          version_code = os.environ.get('VERSION_CODE', '0')
          tag = os.environ.get('TAG', 'v0.0.0')
          # ä¼˜å…ˆä½¿ç”¨ env ä¸­çš„ RELEASE_NOTESï¼›è‹¥ä¸ºç©ºï¼Œåˆ™è¯»å–æ–‡ä»¶ release_notes_short.txt
          release_notes = os.environ.get('RELEASE_NOTES')
          if not release_notes:
              try:
                  with open('release_notes_short.txt', 'r', encoding='utf-8') as f:
                      release_notes = f.read().strip()
              except FileNotFoundError:
                  release_notes = f'ç‰ˆæœ¬ {version} å·²å‘å¸ƒ'

          # ä½¿ç”¨ ISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼ˆUTCï¼‰
          current_timestamp = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')

          # è¯»å–ç°æœ‰çš„ version.jsonï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          try:
              with open('version.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              data = {}

          # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
          data['version'] = version
          data['version_code'] = int(version_code) if version_code.isdigit() else 0
          data['download_url'] = f"https://github.com/BryceWG/LexiSharp-Keyboard/releases/tag/{tag}"
          data['release_notes'] = release_notes
          data['min_supported_version'] = data.get('min_supported_version', '2.6.5')
          data['update_time'] = current_timestamp

          # å†™å…¥æ–‡ä»¶
          with open('version.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print(f"âœ… version.json å·²æ›´æ–°ä¸ºç‰ˆæœ¬ {version}")
          PY

          # æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
          echo "ğŸ“„ version.json å†…å®¹:"
          cat version.json

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet version.json; then
            echo "version_changed=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ version.json æ— å˜åŒ–"
          else
            echo "version_changed=true" >> "$GITHUB_OUTPUT"
            echo "âœ… version.json å·²æ›´æ–°"
          fi
        env:
          VERSION: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
          TAG: ${{ steps.tag.outputs.tag }}
          # RELEASE_NOTES é€šè¿‡æ–‡ä»¶å›é€€ï¼Œä¸å†ä¾èµ–å¤šè¡Œ step è¾“å‡º
          RELEASE_NOTES: ""

      - name: Commit and push version.json
        if: steps.update_version_json.outputs.version_changed == 'true'
        run: |
          echo "ğŸ“¤ æäº¤ version.json æ›´æ–°..."

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æœ€å¤šé‡è¯• 3 æ¬¡
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."

            # æ‹‰å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹
            git fetch origin ${{ github.ref_name }}
            git reset --hard origin/${{ github.ref_name }}

            # é‡æ–°åº”ç”¨ version.json æ›´æ”¹
            python3 - <<'PY'
          import json
          import os
          from datetime import datetime

          version = os.environ.get('VERSION', '0.0.0')
          version_code = os.environ.get('VERSION_CODE', '0')
          tag = os.environ.get('TAG', 'v0.0.0')
          release_notes = os.environ.get('RELEASE_NOTES')
          if not release_notes:
              try:
                  with open('release_notes_short.txt', 'r', encoding='utf-8') as f:
                      release_notes = f.read().strip()
              except FileNotFoundError:
                  release_notes = f'ç‰ˆæœ¬ {version} å·²å‘å¸ƒ'

          current_timestamp = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')

          try:
              with open('version.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              data = {}

          data['version'] = version
          data['version_code'] = int(version_code) if version_code.isdigit() else 0
          data['download_url'] = f"https://github.com/BryceWG/LexiSharp-Keyboard/releases/tag/{tag}"
          data['release_notes'] = release_notes
          data['min_supported_version'] = data.get('min_supported_version', '2.6.5')
          data['update_time'] = current_timestamp

          with open('version.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          PY

            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if git diff --quiet version.json; then
              echo "â„¹ï¸ version.json æ— å˜åŒ–ï¼Œæ— éœ€æ¨é€"
              break
            fi

            # æäº¤æ›´æ”¹
            git add version.json
            git commit -m "chore: auto-update version.json to ${{ steps.version.outputs.version_name }} [skip ci]"

            # å°è¯•æ¨é€
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "âœ… version.json å·²æˆåŠŸæ¨é€"
              break
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å†²çª"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
              else
                echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          done
        env:
          VERSION: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
          TAG: ${{ steps.tag.outputs.tag }}
          RELEASE_NOTES: ""

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Release ${{ steps.tag.outputs.version_display }}"
          body_path: changelog.md
          files: ${{ steps.rename_apk.outputs.renamed_apk_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
